<!doctype html>
<html lang="zh-Hant-TW">

<head>
  <title>GustyのLife A/E</title>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- icon 路徑 -->
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon" />
  <!-- jquery ui css -->
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/Start/jquery-ui.css">
  <!-- dropzone+imgur css -->
  <link rel="stylesheet" href="../css/imgur.css">
  <style>

  </style>
</head>

<body style="background-color:#F0F0F0;">
  <div w3-include-html="life_header.html"></div>
  <br><br><br>
  <div class="container">
    <div class='row justify-content-center text-primary display-2 font-weight-bold'>
      生活日誌&nbsp新增/編輯
    </div>
    <br>
    <div class="col-sm-12 h3" id='editBlock'>

      <div class="form-group row">
        <label for="title" class="col-sm-2 col-form-label text-info">標題</label>
        <div class="col-sm-6 mt-2">
          <input type="text" class="form-control" id="title">
        </div>
      </div>

      <div class="form-group row">
        <label for="time" class="col-sm-2 col-form-label text-info">時間</label>
        <div class="col-sm-6 mt-2">
          <input type="text" class="form-control" id="time" readonly='true'>
        </div>
      </div>

      <div class="form-group row">
        <label for="label" class="col-sm-2 col-form-label text-info">標籤</label>
        <div class="col-sm-4 mt-2">
          <select class="form-control" id="label">
            <option>請選擇</option>
          </select>
        </div>
        <div class="col-sm-4 mt-2">
          <input type="text" class="form-control">
        </div>
      </div>

      <div class="form-group row">
        <label class="col-sm-2 col-form-label text-info">封面圖</label>
        <div class="col-sm-10 mt-2">
          <div class="dropzone"></div>
        </div>
      </div>

      <div class="form-group row">
        <label class="col-sm-2 text-info">預覽圖</label>
        <img src="" id="previewImg" onError="this.onerror=null;this.src='../images/life/404.jpg'"
          class="rounded img-fluid" alt="尚未上傳" style="width: 550px;height: 400px;">
      </div>

      <div class="form-group row">
        <label for="summary" class="col-sm-2 col-form-label text-info">摘要</label>
        <div class="col-sm-12 mt-2">
          <textarea id="summary" class="form-control" style="resize: none;"></textarea>
        </div>
      </div>

      <div class="form-group row">
        <label for="content" class="col-sm-2 col-form-label text-info">內容</label>
        <div class="col-sm-12 mt-2">
          <textarea id="content" class="form-control" name="content"></textarea>
        </div>
      </div>

      <button type="button" class="btn btn-primary float-right" id="preview">預覽</button>
      <br>
    </div>

    <div id="previewBlock" style="background-color: #FFFFFF;">
      <div class='row justify-content-center text-primary display-2 font-weight-bold' id='previewTitle'>
      </div>
      <div class='row justify-content-center h2 mt-1 text-danger' id="previewTime">
      </div>
      <div class='row justify-content-center h2 mt-1 text-success' id="previewLabel">
      </div>
      <div class='row justify-content-center h2 mt-3'>
        <img src="" id="previewImg2" style="width: 550px;height: 400px;"
          onError="this.onerror=null;this.src='../images/life/404.jpg'" class="rounded img-fluid">
      </div>
      <div class='row justify-content-center mt-3'>
        <div class="col-sm-8 mt-3" id="previewContent">
        </div>
      </div>
      <div class="row justify-content-end my-3 mr-3">
        <button type="button" class="btn btn-danger mr-3" id="back">返回</button>
        <button type="button" class="btn btn-primary mr-3" id="define">確定</button>
      </div>
      <br>
    </div>

  </div>

  <div id="goTop">
    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor"
      class="bi bi-arrow-up-circle-fill" viewBox="0 0 16 16">
      <path
        d="M16 8A8 8 0 1 0 0 8a8 8 0 0 0 16 0zm-7.5 3.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11.5z" />
    </svg>
  </div>

  <div w3-include-html="../footer.html"></div>

  <!-- JQuery  -->
  <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
    crossorigin="anonymous"></script>
  <!-- Bootstrap4 js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous">
  </script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous">
  </script>
  <!-- w3school js -->
  <script src="https://www.w3schools.com/lib/w3.js"></script>
  <!-- Sweetalert2 js -->
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@10"></script>
  <!-- jquery ui js -->
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <!-- ckeditor js -->
  <script src="../js/ckeditor.js"></script>
  <!-- dropzone+imgur js -->
  <script src="../js/imgur.js"></script>
  <!-- filesaver js -->
  <script src="../js/FileSaver.min.js"></script>
  <!-- cursor js -->
  <script src="../js/fairyDustCursor.js"></script>
  <!-- bubbly js -->
  <script src="../js/bubbly-bg.js"></script>
  <!-- common js -->
  <script src="../js/common.js"></script>

  <script>
    w3.includeHTML(); //引入html
    var lifeArray = [];
    var life = {};
    var title = '';
    var time = '';
    var label = '';
    var summary = '';
    var content = '';
    var coverImg = '';
    var getUrlString = location.href;
    var url = new URL(getUrlString);
    var urlOrder = url.searchParams.get('order');
    var labelArray = [];

    //datepicker時間格式
    $("#time").datepicker({
      dateFormat: 'yy-mm-dd',
    });

    //初始化ckeditor和dropzone 編輯抓取的資料
    $(document).ready(function () {
      let editLabel = '';
      $('#previewBlock').hide();
      CKEDITOR.replace('content', {
        height: '75vh',
        uiColor: '#95CACA'
      });

      var callback = function (res) {
        if (res.success === true) {
          $('#previewImg').attr('src', res.data.link);
          $('#previewImg2').attr('src', res.data.link)
        }
      };

      new Imgur({
        clientid: '0a4c1d7727faf54',
        callback: callback
      });

      $.get("../data/life/life.json", function (result) {
        lifeArray = result;
        for (let i = 0; i < lifeArray.length; i = i + 1) {
          if (i == 0) {
            labelArray.push(lifeArray[i].label);
          } else {
            let labelRepeat = 0;
            for (let j = 0; j < labelArray.length; j = j + 1) {
              if (lifeArray[i].label == labelArray[j]) {
                labelRepeat = 1;
                break;
              }
            }
            if (labelRepeat == 0) {
              labelArray.push(lifeArray[i].label);
            }
          }
        }

        if (urlOrder != '' || urlOrder != null) {
          for (let i = 0; i < lifeArray.length; i = i + 1) {
            if (lifeArray[i].order == urlOrder) {
              document.title = lifeArray[i].title;
              editLabel = lifeArray[i].label;
              $('#title').val(lifeArray[i].title);
              $('#time').val(lifeArray[i].time);
              $('#previewImg').attr('src', lifeArray[i].coverImg);
              $('#previewImg2').attr('src', lifeArray[i].coverImg);
              $('#summary').val(lifeArray[i].summary);
              CKEDITOR.instances.content.setData(lifeArray[i].content)
              break;
            }
          }
        }
        setTimeout(function () {
          for (let i = 0; i < labelArray.length; i = i + 1) {
            $('#label').append('<option>' + labelArray[i] + '</option>')
          }
        }, 200);

        setTimeout(function () {
          $('select').find('option').each(function (index, value) {
            if ($(this).text().trim() == editLabel) {
              $('select').val(editLabel);
            }
          });
        }, 400);

      }, 'json');
    });

    //確定預覽
    $('#preview').click(function () {
      title = $('#title').val().trim();
      time = $('#time').val().trim();
      label = $('#label').val().trim();
      summary = $('#summary').val().trim();
      content = CKEDITOR.instances.content.getData()

      if (label == '請選擇') {
        label = $('#label').parent().parent().find('input').val().trim();
        if (label == '') {
          Swal.fire({
            icon: 'error',
            html: '<span class="h3">label請寫好</span>',
            showConfirmButton: false,
          });
          return false;
        }
      }

      if (title == '' || time == '' || summary == '' || content == '') {
        Swal.fire({
          icon: 'error',
          html: '<span class="h3">請填寫完整資料</span>',
          showConfirmButton: false,
        });
        return false;
      }

      if ($('#previewImg').attr('src').trim() == '../images/life/404.jpg') {
        Swal.fire({
          icon: 'error',
          html: '<span class="h3">請確認圖片是否上傳</span>',
          showConfirmButton: false,
        });
        return false;
      }

      $('#previewTitle').text(title);
      $('#previewTime').html('<i class="fas fa-calendar-alt mt-1"></i>&nbsp' + time);
      $('#previewLabel').html('<i class="fas fa-tag mt-1"></i>&nbsp' + label);
      $('#previewContent').html(content);
      $('html').animate({
        scrollTop: 0,
      });
      $('#editBlock').fadeOut('slow');
      $('#previewBlock').fadeIn('slow');
    });

    //預覽返回
    $('#back').click(function () {
      $('html').animate({
        scrollTop: 0,
      });
      $('#previewBlock').fadeOut('slow');
      $('#editBlock').fadeIn('slow');
    });

    //預覽後確定送出
    $('#define').click(function () {
      //下載文件無法指定位置因為安全規定...
      let edit = 0;
      for (let i = 0; i < lifeArray.length; i = i + 1) {
        if (lifeArray[i].order == urlOrder) {
          lifeArray[i].title = title;
          lifeArray[i].time = time;
          lifeArray[i].label = label;
          lifeArray[i].coverImg = $('#previewImg').attr('src');
          lifeArray[i].summary = summary;
          lifeArray[i].content = content;
          edit = 1;
        }
      }
      if (edit == 0) {
        life.order = parseInt(lifeArray[lifeArray.length - 1].order + 1);
        life.title = title;
        life.time = time;
        life.label = label;
        life.coverImg = $('#previewImg').attr('src');
        life.summary = summary;
        life.content = content;
        lifeArray.push(life);
        var blob = new Blob([JSON.stringify(lifeArray)], {
          type: ""
        });
        saveAs(blob, "life.json");
      } else {
        var blob = new Blob([JSON.stringify(lifeArray)], {
          type: ""
        });
        saveAs(blob, "life.json");
      }
    });
  </script>

</body>

</html>