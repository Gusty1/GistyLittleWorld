<!doctype html>
<html lang="zh-Hant-TW">

<head>
  <title>GustyのLife A/E</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="../css/jquery-ui.min.css">
  <link rel="stylesheet" href="../css/imgur.css">
</head>

<body>
  <header></header>
  <br><br><br>

  <div class="container-xl">
    <div class='row justify-content-center text-primary display-2 font-weight-bold mb-3'>
      生活日誌&nbsp;新增/編輯
    </div>

    <div class="col-sm-12 h3" id='editBlock'>
      <div class="form-group row">
        <label for="title" class="col-sm-2 col-form-label text-info">標題</label>
        <div class="col-sm-6 mt-2">
          <input type="text" class="form-control" id="title">
        </div>
      </div>
      <div class="form-group row">
        <label for="time" class="col-sm-2 col-form-label text-info">時間</label>
        <div class="col-sm-6 mt-2">
          <input type="text" class="form-control" id="time" readonly='true'>
        </div>
      </div>
      <div class="form-group row">
        <label for="label" class="col-sm-2 col-form-label text-info">標籤</label>
        <div class="col-sm-4 mt-2">
          <select class="form-control" id="label">
            <option>請選擇</option>
          </select>
        </div>
        <div class="col-sm-4 mt-2">
          <input type="text" class="form-control">
        </div>
      </div>
      <div class="form-group row">
        <label class="col-sm-2 col-form-label text-info">封面圖</label>
        <div class="col-sm-10 mt-2">
          <div class="dropzone"></div>
        </div>
      </div>
      <div class="form-group row">
        <label class="col-sm-2 text-info">預覽圖</label>
        <img src="" id="previewImg" onError="this.onerror=null;this.src='../images/life/404.jpg'" class="rounded img-fluid" alt="尚未上傳" style="width: 550px;height: 400px;">
      </div>
      <div class="form-group row">
        <label for="summary" class="col-sm-2 col-form-label text-info">摘要</label>
        <div class="col-sm-12 mt-2">
          <textarea id="summary" class="form-control" style="resize: none;"></textarea>
        </div>
      </div>
      <div class="form-group row">
        <label for="content" class="col-sm-2 col-form-label text-info">內容</label>
        <div class="col-sm-12 mt-2">
          <textarea id="content" class="form-control" name="content"></textarea>
        </div>
      </div>
      <div class="col-12 text-right mb-3">
        <button type="button" class="btn btn-primary" id="preview">預覽</button>
      </div>
    </div>

    <div class="row" id="previewBlock">
      <div class='col-12 text-primary display-2 text-center font-weight-bold' id='previewTitle'>
      </div>
      <div class='col-12 h2 mt-1 text-danger text-center' id="previewTime">
      </div>
      <div class='col-12 h2 mt-1 text-success text-center' id="previewLabel">
      </div>
      <div class='col-12 h2 mt-3 text-center'>
        <img src="" id="previewImg2" style="width: 550px;height: 400px;" onError="this.onerror=null;this.src='../images/life/404.jpg'" class="rounded img-fluid">
      </div>
      <div class='col-12 mt-3' id="previewContent">
      </div>
      <div class="col-12 my-3 text-right">
        <button type="button" class="btn btn-danger mr-3" id="back">返回</button>
        <button type="button" class="btn btn-primary mr-3" id="define">確定</button>
      </div>
    </div>
  </div>

  <div class="modal fade" id="authModal" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary">
          <h5 class="modal-title" id="staticBackdropLabel">Auth Modal</h5>
        </div>
        <form>
          <div class="modal-body">
            <div class="input-group mb-3">
              <div class="input-group-prepend">
                <span class="input-group-text"><i class="fas fa-user-secret"></i></span>
              </div>
              <input type="email" class="form-control" placeholder="請輸入電子郵件">
            </div>
            <div class="input-group mb-3">
              <div class="input-group-prepend">
                <span class="input-group-text"><i class="fas fa-lock"></i></span>
              </div>
              <input type="password" class="form-control" placeholder="請輸入密碼">
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">確定</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="goTop">
    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-arrow-up-circle-fill" viewBox="0 0 16 16">
      <path d="M16 8A8 8 0 1 0 0 8a8 8 0 0 0 16 0zm-7.5 3.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11.5z" />
    </svg>
  </div>

  <footer></footer>

  <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@10"></script>
  <script src="../js/jquery-ui.min.js"></script>
  <script src="../js/ckeditor.js"></script>
  <script src="../js/imgur.js"></script>
  <script src="../js/fairyDustCursor.js"></script>
  <script src="../js/bubbly-bg.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.6.5/firebase-database.min.js" integrity="sha512-x+FKkd5Tc/5BaHtn/ZnRsQlzaEihtLaCOev36dCv5eeyGEDf5ou59tz7q6CypiKBN/L51E0Jd5S7jxIg1v8lcg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-auth.js"></script>
  <script src="../js/tool.js"></script>

  <script>
    var lifeArray = [];
    var life = {};
    var title = '';
    var time = '';
    var label = '';
    var summary = '';
    var content = '';
    var coverImg = '';
    var getUrlString = location.href;
    var url = new URL(getUrlString);
    var urlOrder = url.searchParams.get('order');
    var labelArray = [];

    //datepicker時間格式
    $("#time").datepicker({
      dateFormat: 'yy-mm-dd',
    });

    //初始化ckeditor和dropzone 編輯抓取的資料
    $(document).ready(function () {
      $('header').load('header.html')
      $('footer').load('../footer.html')
      let editLabel = '';
      $('#previewBlock').hide();
      CKEDITOR.replace('content', {
        height: '75vh',
        uiColor: '#95CACA'
      });

      let callback = function (res) {
        if (res.success === true) {
          $('#previewImg').attr('src', res.data.link);
          $('#previewImg2').attr('src', res.data.link)
        }
      };

      new Imgur({
        clientid: '0a4c1d7727faf54',
        callback: callback
      });

      database.ref('/life').once('value', function (result) {
        if (!checkUser()) $('#authModal').modal('toggle')
        lifeArray = result.val()

        for (let i = 0; i < lifeArray.length; i = i + 1) {
          labelArray.push(lifeArray[i].label)
        }
        labelArray = labelArray.filter(function (element, index, arr) {
          return arr.indexOf(element) == index;
        });

        if (urlOrder != null) {
          for (let i = 0; i < lifeArray.length; i = i + 1) {
            if (lifeArray[i].order == urlOrder) {
              document.title = lifeArray[i].title;
              editLabel = lifeArray[i].label;
              $('#title').val(lifeArray[i].title);
              $('#time').val(lifeArray[i].time);
              $('#previewImg').attr('src', lifeArray[i].coverImg);
              $('#previewImg2').attr('src', lifeArray[i].coverImg);
              $('#summary').val(lifeArray[i].summary);
              CKEDITOR.instances.content.setData(lifeArray[i].content)
              break;
            }
          }
        }
        setTimeout(function () {
          for (let i = 0; i < labelArray.length; i = i + 1) {
            $('#label').append('<option>' + labelArray[i] + '</option>')
          }
        }, 200);

        setTimeout(function () {
          $('select').find('option').each(function (index, value) {
            if ($(this).text().trim() == editLabel) $('select').val(editLabel)
          });
        }, 400);
      });
    });

    //確定預覽
    $('#preview').click(function () {
      title = $('#title').val().trim();
      time = $('#time').val().trim();
      label = $('#label').val().trim();
      summary = $('#summary').val().trim();
      content = CKEDITOR.instances.content.getData()

      if (label == '請選擇') {
        label = $('#label').parent().parent().find('input').val().trim();
        if (label == '') {
          Swal.fire({
            icon: 'error',
            html: '<span class="h3">label請寫好</span>',
            showConfirmButton: false,
          });
          return false;
        }
      }

      if (title == '' || time == '' || summary == '' || content == '') {
        Swal.fire({
          icon: 'error',
          html: '<span class="h3">請填寫完整資料</span>',
          showConfirmButton: false,
        });
        return false;
      }

      if ($('#previewImg').attr('src').trim() == '../images/life/404.jpg') {
        Swal.fire({
          icon: 'error',
          html: '<span class="h3">請確認圖片是否上傳</span>',
          showConfirmButton: false,
        });
        return false;
      }

      $('#previewTitle').text(title);
      $('#previewTime').html('<i class="fas fa-calendar-alt mt-1"></i>&nbsp;' + time);
      $('#previewLabel').html('<i class="fas fa-tag mt-1"></i>&nbsp;' + label);
      $('#previewContent').html(content);
      $('html').animate({
        scrollTop: 0,
      });
      $('#editBlock').fadeOut('slow');
      $('#previewBlock').fadeIn('slow');
    });

    //預覽返回
    $('#back').click(function () {
      $('html').animate({
        scrollTop: 0,
      });
      $('#previewBlock').fadeOut('slow');
      $('#editBlock').fadeIn('slow');
    });

    //登入並送出
    $('#authModal').on('click', '.btn-primary', function (e) {
      e.preventDefault()
      let email = $('#authModal').find('input').eq(0).val().trim()
      let password = $('#authModal').find('input').eq(1).val().trim()
      if (email == '' || password == '') {
        Swal.fire({
          icon: 'error',
          title: '請輸入電子郵件和密碼',
          showConfirmButton: false,
        });
        return false
      }
      firebase.auth().signInWithEmailAndPassword(email, password).then(() => {
        let user = firebase.auth().currentUser;
        if (user != null && user != '') $('#authModal').modal('toggle');
      }).catch((error) => {
        Swal.fire({
          icon: 'error',
          title: '登入失敗',
          html: '可能帳號或密碼錯誤',
          showConfirmButton: false,
        });
      });
    })

    //預覽後確定送出，沒有登入就去登入
    $('#define').click(function () {
      let user = firebase.auth().currentUser
      if (user == null || user == '') $('#authModal').modal('toggle');
      else updateData()
    });

    //更新或新增資料
    function updateData() {
      //舊時代的產物
      // saveAs(blob, "life.json");
      // var blob = new Blob([JSON.stringify(lifeArray)], {
      //   type: ""
      // });
      let edit;
      if (urlOrder != null) edit = true
      else edit = false
      if (!edit) { //新增
        life.order = parseInt(lifeArray[lifeArray.length - 1].order + 1);
        life.title = title;
        life.time = time;
        life.label = label;
        life.coverImg = $('#previewImg').attr('src');
        life.summary = summary;
        life.content = content;
        database.ref('/life/' + parseInt(lifeArray[lifeArray.length - 1].order)).set(life)
        window.location.href = 'all.html';
      } else { //編輯
        life.order = parseInt(urlOrder);
        life.title = title;
        life.time = time;
        life.label = label;
        life.coverImg = $('#previewImg').attr('src');
        life.summary = summary;
        life.content = content;
        database.ref('/life/' + parseInt(urlOrder - 1)).update(life)
        window.location.href = 'all.html';
      }
    }
  </script>

</body>

</html>