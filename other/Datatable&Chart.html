<!doctype html>
<html lang="zh-Hant-TW">

<head>
    <title>Datatable&Chart</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- icon 路徑 -->
    <link rel="icon" href="../favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon" />
    <!-- dragula css -->
    <link rel="stylesheet" type="text/css" href="../css/dragula.css">
    <!-- Datatable css -->
    <!-- <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/jszip-2.5.0/dt-1.10.24/af-2.3.6/b-1.7.0/b-colvis-1.7.0/b-html5-1.7.0/b-print-1.7.0/cr-1.5.3/date-1.0.3/fc-3.3.2/fh-3.1.8/kt-2.6.1/r-2.2.7/rg-1.1.2/rr-1.2.7/sc-2.0.3/sb-1.0.1/sp-1.2.2/sl-1.3.3/datatables.min.css"/> -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">
    <style>
        label {
            cursor: pointer;
        }
        
        table{
            table-layout: fixed;
            word-wrap:break-word;
        }
    </style>
</head>

<body class="h-100">

    <div w3-include-html="other_header.html"></div>
    <br><br><br>

    <div class="animate__animated animate__bounceInRight container-xl">
        <div class='row justify-content-center display-2 font-weight-bold text-primary'>
            Table+Chart
        </div>
        <div class='row justify-content-start'>
            <div class='col-sm-12 h2 mb-2'>請輸入JSON網址</div>
            <div class='col-sm-12 mb-2'>
                只接受有Array格式的JSON，不支援有2個(含)以上的Array。<br>
                <span class='text-danger'>
                    若使用的是政府部門公開資料網站，有些資料可要要先裝
                    <a
                        href="https://chrome.google.com/webstore/detail/allow-cors-access-control/lhobafahddgcelffkeicbaginigeejlf/related?hl=zh-TW">Chrome插件</a>
                    才能正常使用。<br>能力不足，十分抱歉<i class="fas fa-sad-tear"></i>&nbsp(裝完預設是OFF記得要ON)
                </span>
            </div>
            <div class="input-group col-sm-8">
                <input type="text" id='url' class="form-control" placeholder="請輸入JSON網址">
                <button class="btn btn-primary" type="button" id="urlCheck">確認</button>
            </div>
            <div class="col-sm-4">
                <div class="spinner-border text-success">
                    <span class="visually-hidden"></span>
                </div>
            </div>
            <div class='col-sm-12 mt-2'>
                <span>範例資料</span>:<br>
                1.年度國際主要股價指數:<br>
                https://apiservice.mol.gov.tw/OdService/download/A17000000J-030245-hUa<br>
                2.國際主要國家貨幣年度匯率概況:<br>
                https://apiservice.mol.gov.tw/OdService/download/A17000000J-030185-eun<br>
            </div>
        </div>

        <div class='row justify-content-center alert alert-warning my-3'></div>

        <div class='col-sm-12 my-3' id='successStepBlock'>
            <div class='col-sm-12 text-center h1'>
                獲取JSON資料成功
            </div>
            <div class='row justify-content-start' id='successStep1'>
                <div class='col-sm-12 text-center text-success h2'>
                    Step1: 請選擇要顯示的欄位和順序(由上往下)，最多8個
                </div><br>
                <div class='col-sm-4 text-center h4'>
                    資料的欄位
                    <div class='col-sm-12 border border-primary mt-3' id='dataColnum'>
                    </div>
                </div>
                <div class='col-sm-4 text-center h4' id="rightArrow">
                    <div class='col-sm-12 text-primary'>請將要顯示的欄位拖曳至右邊</div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor"
                        class="bi bi-arrow-right" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z" />
                    </svg>
                    <div class='col-sm-12'>
                        <button class='btn btn-secondary my-2' id='autoDrag'>自動拖曳</button>
                        <button class='btn btn-secondary my-2' id='clearSelectColnum'>清除</button>
                    </div>
                    <span id='colnumCheck'></span>
                </div>
                <div class='col-sm-4 text-center h4'>
                    要顯示的欄位
                    <div class='col-sm-12 border border-danger mt-3' id='selectColnum'>
                    </div>
                </div>
            </div><br>
            <div class='col-sm-12' id='successStep2'>
                <div class='col-sm-12 text-center text-success h2'>
                    Step2: 請選擇要有搜尋功能的欄位，最多2個
                </div>
                <div class='col-sm-12 mt-3 h4' id='selectSearchButton'>
                </div>
            </div>
            <div class='col-sm-12 my-3' id='successStep3'>
                <div class='col-sm-12 text-center text-success h2'>
                    Step3: 請幫您的表格命名
                </div>
                <div class='row justify-content-center'>
                    <div class="col-sm-8 input-group mb-3">
                        <input type="text" id='inputTableName' class="form-control" placeholder="請輸入名稱"
                            aria-label="Recipient's username" aria-describedby="basic-addon2">
                        <div class="input-group-append">
                            <button class="btn btn-warning" type="button">確定</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-12 w-100 progress text-center my-3">
                <div class="radio progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar"
                    aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width:33%">33%</div>
            </div>
        </div>

        <div class='col-sm-12 my-3' id='tableShowBlock'>
            <div class='col-sm-12 text-center display-4 mb-3 font-weight-bold'></div>
            <table class="table table-hover table-striped table table-bordered" id='yourTable'
                style="background-color: white;">
                <thead>
                    <tr></tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div class='col-sm-12' id='chartShowBlock'>
            <button class='btn btn-primary' data-toggle="collapse" data-target="#chartShowOption">新增圖表</button>
            <div class='collapse my-3 col-sm-12' id='chartShowOption'>
                <div class='card card-body'>
                    <div class='row justify-content-start'>
                        <span class='col-sm-4 mt-1'>請選擇圖表種類:&nbsp</span>
                        <select class='col-sm-5 browser-default custom-select' id='chartTypeSelect'>
                            <option value="請選擇">請選擇</option>
                            <option value="圓餅圖">圓餅圖</option>
                            <option value="長條圖">長條圖</option>
                            <option value="折線圖">折線圖</option>
                        </select>
                    </div>
                    <div class='row justify-content-start' id='graphicSet'></div>
                    <div class="sol-sm-12">
                        <div class='row justify-content-end mr-3'><button class='btn btn-info mr-3'>匯出圖檔</button></div>
                        <canvas class='m-3' id="finalChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <br>
        <div class="row justify-content-center mt-3 mb-3">
            <div class="col-sm-8">
                <div class="accordion" id="authorGGYY">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="mb-0 text-center"><i class="fas fa-skull"></i>
                                <button class="btn btn-link" type="button" data-toggle="collapse"
                                    data-target="#description1" aria-expanded="true" aria-controls="description1">
                                    創作動機
                                </button>
                            </h2>
                        </div>
                        <div id="description1" class="collapse" data-parent="#authorGGYY">
                            <div class="card-body">
                                某天上班用到Datatable想說就順便練習一下。<br>
                                又想說都有Datatable那順便也練習一下Chart。就醬。
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="mb-0 text-center"><i class="fas fa-meteor"></i>
                                <button class="btn btn-link collapsed" type="button" data-toggle="collapse"
                                    data-target="#description2" aria-expanded="false" aria-controls="description2">
                                    功能說明
                                </button>
                            </h2>
                        </div>
                        <div id="description2" class="collapse" data-parent="#authorGGYY">
                            <div class="card-body">
                                就只能讀JSON格式，網址有限定http開頭，資料過長我有做處理；看起來比較好看一點。<br>
                                圖表部分，資料不是數字會被過濾；匯出圖片沒有很清晰。<br>
                                一定要先弄出table才可以產生圖表。<br>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header" id="headingThree">
                            <h2 class="mb-0 text-center"><i class="fas fa-ghost"></i>
                                <button class="btn btn-link collapsed" type="button" data-toggle="collapse"
                                    data-target="#description3" aria-expanded="false" aria-controls="description3">
                                    心得感想
                                </button>
                            </h2>
                        </div>
                        <div id="description3" class="collapse" aria-labelledby="headingThree"
                            data-parent="#authorGGYY">
                            <div class="card-body">
                                這2個東西以前在資策會都有用過，但用的不多，現在回來寫一大堆問題...。<br>
                                尤其是那個圖表匯出，花了我超多時間，明明就沒幾行程式，可惡。<br>
                                圖表這工具就真的很強，差別就是這次處理資料很複雜；還好最後還想得出來。
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="goTop">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor"
            class="bi bi-arrow-up-circle-fill" viewBox="0 0 16 16">
            <path
                d="M16 8A8 8 0 1 0 0 8a8 8 0 0 0 16 0zm-7.5 3.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11.5z" />
        </svg>
    </div>

    <div w3-include-html="../footer.html"></div>

    <!-- JQuery  -->
    <script src="https://code.jquery.com/jquery-3.6.0.js"
        integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <!-- Bootstrap4 js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous">
    </script>
    <!-- draggable js -->
    <script src="https://cdn.jsdelivr.net/npm/@shopify/draggable@1.0.0-beta.12/lib/draggable.js"></script>
    <!-- Sweetalert2 js -->
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <!-- live 2D js -->
    <script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <!-- Datatable js -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js">
    </script>
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.0/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.html5.min.js"></script>
    <!-- blockUI js -->
    <script src="../js/jquery.blockUI.js"></script>
    <!-- JQuery UI js -->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <!-- Chart js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <!-- html2canvas js -->
    <script src="../js/html2canvas.js"></script>
    <!-- Dragula js -->
    <script src="../js/dragula.js"></script>
    <!-- w3school js -->
    <script src="https://www.w3schools.com/lib/w3.js"></script>
    <!-- cursor js -->
    <script src="../js/fairyDustCursor.js"></script>
    <!-- bubbly js -->
    <script src="../js/bubbly-bg.js"></script>
    <!-- socila share js -->
    <script src="../js/social-share-kit.js"></script>
    <!-- firebase realtimedatabase -->
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.6.5/firebase-database.min.js"
        integrity="sha512-x+FKkd5Tc/5BaHtn/ZnRsQlzaEihtLaCOev36dCv5eeyGEDf5ou59tz7q6CypiKBN/L51E0Jd5S7jxIg1v8lcg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- common js -->
    <script src="../js/common.js"></script>

    <script>
        w3.includeHTML(); //引入html
        var drag = 0 //拖曳元素
        var jsonUrl; //json資料取得成功保存網址
        var finalDataTable = 0; //判斷是否2次搜尋table
        var successData = []; //成功時取得資料陣列
        var ctx = document.getElementById("finalChart").getContext('2d'); //圖表
        var myChart = 0; //判斷是否更新chart
        var isClcik = 0; //展開視窗是否被過
        var numLabel = []; //是數字的資料欄位

        $(document).ready(function () { //init
            $('.alert').hide();
            $('.spinner-border').hide();
            $('#successStepBlock').hide();
            $('#successStep2').hide();
            $('#successStep3').hide();
            $('#tableShowBlock').hide();
            $('#chartShowBlock').hide();
        })

        //url確定button
        $('#urlCheck').click(function () {
            if ($('#url').val() == '') {
                $('.alert').html('<i class="fas fa-exclamation-triangle h4"></i>&nbsp&nbsp網址為空');
                $('.alert').show();
                return false;
            } else if ($('#url').val().indexOf('http') == -1) {
                $('.alert').html('<i class="fas fa-exclamation-triangle h4">&nbsp&nbsp請輸入正確的網址格式');
                $('.alert').show();
                return false;
            }
            //2次搜尋的回覆初始設定
            if (drag != 0) {
                drag.destroy();
            }
            if (finalDataTable != 0) {
                finalDataTable.destroy();
            }
            if (myChart != 0) {
                myChart.destroy();
            }
            $('.alert').hide();
            $('.spinner-border').show();
            $('#successStepBlock').hide();
            $('#selectColnum').html('');
            $('#dataColnum').html('');
            $('#colnumCheck').html('');
            $('#step1OK').attr('disabled', false);
            $('#clearSelectColnum').attr('disabled', false);
            $("#autoDrag").attr('disabled', false);
            $('#successStep2').hide();
            $('#dataColnum').css('height', 'auto');
            $('#successStep3').hide();
            $('#selectSearchButton').html('');
            $('.progress-bar').css('width', '33%').text('33%');
            $('#tableShowBlock').hide();
            $('#inputTableName').val('');
            $('#yourTable').find('tr').html('');
            $('#yourTable').find('tbody').html('');
            $('#chartShowBlock').hide();
            $('#graphicSet').html('');
            $('select').val('請選擇');
            $('#graphicSet').next().hide();
            setTimeout(function () {
                $.ajax({
                    url: $('#url').val().trim(),
                    // type: 'post',
                    dataType: 'json',
                    async: false,
                    success: function (result) {
                        $('.spinner-border').hide();
                        if (result == null || result == '') {
                            $('.alert').text('資料為空');
                            $('.alert').show();
                        } else {
                            var jsonArray = [];
                            if (Array.isArray(result)) {
                                jsonArray.push(result)
                            } else {
                                for (var key in result) {
                                    if (Array.isArray(result[key])) {
                                        jsonArray.push(result[key])
                                    }
                                }
                            }
                            if (jsonArray.length > 1) {
                                Swal.fire({
                                    icon: 'error',
                                    title: '不支援包含2個Array的JSON',
                                    // showCancelButton: false,
                                    confirmButtonText: '確定',
                                    // allowOutsideClick: false,
                                });
                            } else {
                                jsonUrl = $('#url').val().trim();
                                success_SelectDataColnum(jsonArray);
                            }
                        }
                    },
                    error: function (jqXHR) {
                        $('.spinner-border').hide();
                        if (jqXHR.status == 200) {
                            $('.alert').html(
                                '<i class="fas fa-exclamation-triangle h4"></i>&nbsp&nbsp回應成功；但還是發生問題，換個網址或稍後再試'
                            );
                            $('.alert').show();
                        } else if (jqXHR.status == 400) {
                            $('.alert').html(
                                '<i class="fas fa-exclamation-triangle h4"></i>&nbsp&nbsp此回應意味伺服器因為收到無效語法，而無法理解請求'
                            );
                            $('.alert').show();
                        } else if (jqXHR.status == 404) {
                            $('.alert').html(
                                '<i class="fas fa-exclamation-triangle h4"></i>&nbsp&nbsp伺服器找不到請求的資源'
                            );
                            $('.alert').show();
                        } else if (jqXHR.status == 405) {
                            $('.alert').html(
                                '<i class="fas fa-exclamation-triangle h4"></i>&nbsp&nbsp伺服器理解此請求方法，但它被禁用或不可用'
                            );
                            $('.alert').show();
                        } else {
                            $('.alert').html(
                                '<i class="fas fa-exclamation-triangle h4"></i>&nbsp&nbsp發生預期之外的問題，換個網址試試看。若是政府資料請安裝Chrome插件'
                            );
                            $('.alert').show();
                        }
                    }
                });
            }, 400);
        });

        //處理url取得的jsonArray資料
        function success_SelectDataColnum(jsonArray) {
            var colArray = []; //排序用陣列
            for (var key in jsonArray[0]) {
                for (var jsonKey in jsonArray[0][key]) {
                    colArray.push(jsonKey);
                }
                break;
            }
            colArray.sort(function (a, b) {
                if (a.length > b.length) {
                    return 1;
                } else if (a.length == b.length) {
                    if (a[0] > b[0]) {
                        return 1;
                    } else {
                        return -1;
                    }
                } else {
                    return -1
                }
            });
            for (let i = 0; i < colArray.length; i = i + 1) {
                $('#dataColnum').append('<label class="h4 border border-dark my-2 w-100 bg-info text-center">' +
                    colArray[i] + '</label>');
            }
            $('#successStepBlock').show();
            $('#selectColnum').css('height', $('#dataColnum').height());
            $('#rightArrow').css('height', $('#dataColnum').height() / 2).addClass('align-self-center');
            $('#dataColnum').css('height', $('#selectColnum').height());
            for (let i = 0; i < $('#dataColnum').find('label').length; i = i + 1) {
                $('#dataColnum').find('label').eq(i).css('width', $('#dataColnum').find('label').eq(0).width());
                $('#dataColnum').find('label').eq(i).removeClass('w-100');
            }
            drag = dragula([document.getElementById('dataColnum'), document.getElementById('selectColnum')], {
                invalid: function (el, handle) {
                    if ($('#selectColnum').find('label').length >= 8 || $('#dataColnum').find('label')
                        .length == 0) {
                        $("#selectColnum").sortable({
                            disabled: $('#step1OK').attr('disabled') == 'disabled',
                        });
                        return true;
                    } else {
                        return false;
                    }
                },
                revertOnSpill: true,
            }).on('drop', function () {
                if ($('#selectColnum').find('label').length == 8 || $('#dataColnum').find('label').length ==
                    0) {
                    $('#colnumCheck').append(
                        '已選滿，請調整並確認右邊欄位順序後按下<button class="btn btn-warning id="step1OK">確定</button>')
                    $('#selectColnum').find('label').each(function () {
                        $(this).html('<i class="fas fa-arrows-alt-v float-left mx-3 text-light"></i>' +
                            $(this).html())
                    });
                } else {
                    $('#colnumCheck').html('');
                }
            });
        }

        //自動拖曳
        $("#autoDrag").click(function () {
            if ($('#colnumCheck').text() != '') {
                return false;
            }
            $('#dataColnum').find('label').each(function () {
                if ($('#selectColnum').find('label').length == 8) {
                    return false;
                } else {
                    $('#selectColnum').append($(this));
                }
            });
            $('#colnumCheck').append(
                '<br>已選滿，請調整並確認右邊欄位順序後按下<button class="btn btn-warning" id="step1OK">確定</button>')
            $('#selectColnum').find('label').each(function () {
                $(this).html('<i class="fas fa-arrows-alt-v float-left mx-3 text-light"></i>' + $(this)
                    .html())
            });
        });

        //清除拖曳
        $('#clearSelectColnum').click(function () {
            var colArray = [];
            $("#selectColnum").sortable({
                disabled: true,
            });
            $('#selectColnum').find('label').each(function () {
                $(this).html($(this).html().substring($(this).html().indexOf('</i>')));
            });
            $('#colnumCheck').html('');
            if ($('#selectColnum').find('label').length == 0) {
                return false;
            } else {
                $('#selectColnum').find('label').each(function () {
                    $('#dataColnum').append($(this));
                });
            }
            colArray = $('#dataColnum').find('label');
            colArray.sort(function (a, b) {
                if (a.innerHTML.length > b.innerHTML.length) {
                    return 1;
                } else if (a.innerHTML.length == b.innerHTML.length) {
                    if (a.innerHTML[0] > b.innerHTML[0]) {
                        return 1;
                    } else {
                        return -1;
                    }
                } else {
                    return -1;
                }
            });
            $('#dataColnum').html('')
            for (let i = 0; i < colArray.length; i = i + 1) {
                $('#dataColnum').append(colArray[i])
            }
        });

        //拖曳完成的確定按鈕
        $('#colnumCheck').on('click', '.btn', function () {
            $('label').css('cursor', 'default');
            $('#step1OK').attr('disabled', true);
            $('#clearSelectColnum').attr('disabled', true);
            $("#autoDrag").attr('disabled', true);
            $('#selectColnum').find('label').each(function () {
                $("#selectSearchButton").append(
                    '<button type="button" class="btn btn-outline-info m-2">' + $(this).text() +
                    '</button>')
            });
            $('#selectSearchButton').append('<span class="mx-3"></span>');
            $("#successStep2").show('fast');
            $('.progress-bar').css('width', '66%').text('66%');
        });

        //選擇2個要搜尋的欄位
        $('#selectSearchButton').on('click', '.btn', function () {
            var selectCount = 0;
            $('#selectSearchButton').find('button').each(function () {
                if ($(this).hasClass('btn-dark')) {
                    selectCount = selectCount + 1;
                }
            })
            if ($(this).text() == '確定') {
                $('#selectSearchButton').find('button').attr('disabled', true);
                $('#successStep3').show('fast');
                $('.progress-bar').css('width', '99%').text('99%');
                return false;
            }

            if (selectCount >= 2) {
                if ($(this).hasClass('btn-dark')) {
                    $(this).removeClass('btn-dark');
                    $(this).addClass('btn-outline-info');
                    $('#selectSearchButton').find('span').html('');
                }
                return false;
            } else if ($(this).hasClass('btn-dark')) {
                $(this).removeClass('btn-dark');
                $(this).addClass('btn-outline-info');
            } else {
                $(this).removeClass('btn-outline-info');
                $(this).addClass('btn-dark');
            }
            $(this).siblings('.btn').each(function () {
                if ($(this).hasClass('btn-dark')) {
                    return;
                } else {
                    $(this).removeClass('btn-dark');
                    $(this).addClass('btn-outline-info');
                }
            });
            selectCount = 0;
            $('#selectSearchButton').find('button').each(function () {
                if ($(this).hasClass('btn-dark')) {
                    selectCount = selectCount + 1;
                }
            })
            if (selectCount == 2) {
                $('#selectSearchButton').find('span').append(
                    '<br>已選滿，請確認後按下<button class="btn btn-warning">確定</button>');
            } else {
                $('#selectSearchButton').find('span').html('');
            }
        });

        //輸入表格名稱
        $('#successStep3').on('click', '.btn', function () {
            if ($('#successStep3').find('input').val() == '') {
                Swal.fire({
                    icon: 'error',
                    title: '名稱不可為空',
                    // showCancelButton: false,
                    confirmButtonText: '確定',
                    // allowOutsideClick: false,
                });
                return false;
            } else {
                $.blockUI({
                    message: '<div class="spinner-border text-primary h1" style="width: 3rem; height: 3rem;" role="status">' +
                        '<span class="sr-only"></span>' +
                        '</div>',
                    css: {
                        borderWidth: '0px',
                        backgroundColor: 'transparent'
                    },
                });
                setTimeout(function () {
                    $.unblockUI();
                    finalTable();
                }, 1000);
            }
        });

        //構築Table
        function finalTable() {
            $('#tableShowBlock').find('div').eq(0).text($('#inputTableName').val().trim());
            $('#successStepBlock').hide();
            $('#tableShowBlock').show();
            $('#selectColnum').find('label').each(function (index, value) {
                if (index == 0) {
                    $('#yourTable').find('tr').eq(0).append('<th>' + $(this).text() + '</th>');
                } else if (index == $('#selectColnum').find('label').length - 1) {
                    $('#yourTable').find('tr').eq(0).append('<th>' + $(this).text() + '</th>');
                } else {
                    $('#yourTable').find('tr').eq(0).append('<th>' + $(this).text() + '</th>');
                }
            });

            var columnsArray = [];
            $('#yourTable').find('th').each(function (index, value) {
                var column = {};
                column.data = $(this).text().trim();
                columnsArray.push(column);
            });

            $.ajax({
                url: $('#url').val().trim(),
                // type: 'post',
                dataType: 'json',
                async: false,
                success: function (result) {
                    var jsonArray = [];
                    if (Array.isArray(result)) {
                        jsonArray.push(result)
                    } else {
                        for (var key in result) {
                            if (Array.isArray(result[key])) {
                                jsonArray.push(result[key])
                            }
                        }
                    }
                    successData = jsonArray[0];
                    finalDataTable = $('#yourTable').DataTable({
                        "data": jsonArray[0],
                        "dom": "<'row'<'col-sm-8 d-flex justify-content-start searchBar'<'d-none'f>><'col-sm-4 d-flex justify-content-end'<'mr-3'l>B>>tip",
                        "responsive": true,
                        "autoWidth": false,
                        "buttons": [{
                                extend: 'excelHtml5',
                                charset: 'UTF-8',
                                bom: true,
                                className: 'btn btn-info',
                                title: $('#inputTableName').val(),
                                text: "EXCEL",
                            },
                            {
                                extend: 'csvHtml5',
                                charset: 'UTF-8',
                                bom: true,
                                className: 'btn btn-info',
                                title: $('#inputTableName').val(),
                                text: "CSV",
                            },
                            // {無法顯示中文，操作異常複雜。放棄
                            //     extend: 'pdfHtml5',
                            //     charset: 'UTF-8',
                            //     bom: true,
                            //     className:'btn btn-info',
                            //     title: $('#inputTableName').val(),
                            //     download: 'open',
                            //     text: "PDF",
                            //     customize: function (doc) {//讓PDF的width:100%
                            //         doc.defaultStyle.font = 'msyh';
                            //         doc.content[1].table.widths =
                            //             Array(doc.content[1].table.body[0].length + 1).join('*').split('');
                            //     }
                            // },
                        ],
                        "columns": columnsArray,
                        "language": {
                            "emptyTable": "無資料...",
                            "processing": "處理中...",
                            "loadingRecords": "載入中...",
                            "lengthMenu": "顯示 _MENU_ 項結果",
                            "zeroRecords": "沒有符合的結果",
                            "info": "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
                            "infoEmpty": "顯示第 0 至 0 項結果，共 0 項",
                            "search": "搜尋:",
                            "scrollX": true,
                            "infoFiltered": "(全部過濾 _MAX_ 項資料)",
                            "paginate": {
                                "previous": "<<",
                                "next": ">>",
                            },
                        }
                    });
                    var searchIndex = 0;
                    $('#selectSearchButton').find('.btn').each(function (index, value) {
                        if ($(this).hasClass('btn-dark')) {
                            searchIndex = searchIndex + 1;
                            $('.searchBar').append('<div class="form-group row ml-3">' +
                                '<label class= "col-form-label" for="search' + searchIndex +
                                '">' + $(this).text() + ':</label>' +
                                '<div class="col-sm-8">' +
                                '<input type="text" id="search' + searchIndex +
                                '" class="form-control" placeholder=搜尋"' + $(this).text() +
                                '">' +
                                '</div></div>');
                        }
                    });
                },
                error: function (jqXHR) {
                    Swal.fire({
                        icon: 'error',
                        title: '發生錯誤',
                        text: '5秒後自動重新整理或按確定立刻重新整理',
                        // showCancelButton: false,
                        confirmButtonText: '確定',
                        allowOutsideClick: false,
                        timer: 5000,
                    }).then((result) => {
                        window.location.reload();
                    });
                }
            });
            if (isClcik != 0) {
                $('#chartShowBlock').find('button').eq(0).click();
            }
            $('#chartShowBlock').show();
        }

        //搜尋欄位*2
        $('#tableShowBlock').on('input', '#search1,#search2', function () {
            var searchTitle = $(this).parent().prev().text().replace(':', '').trim();
            var searchVal = $(this).val().trim();
            $('#yourTable').find('th').each(function (index, value) {
                if ($(this).text().trim() == searchTitle) {
                    finalDataTable.column(index).search(searchVal).draw();
                }
            })
        });

        //欄位過長換頁要跟者顯示縮短
        $('#yourTable').on('draw.dt', function () {
            $('#yourTable').find('td').each(function (index, value) {
                if ($(this).text().trim().length >= 10) {
                    var tooLongHtml = $(this).text().trim().substring(0, 10) +
                        '...<button class="btn btn-default" data-info="' + $(this).text().trim() +
                        '"><i class="fas fa-info"></i></button>';
                    $(this).html(tooLongHtml);
                }
            });
        });

        //欄位過長顯示
        $('#tableShowBlock').on('click', '.btn-default', function () {
            if ($(this).hasClass('border')) {
                $(this).removeClass('border');
                $(this).removeClass('border-danger');
            } else {
                $('#yourTable').find('button').each(function () {
                    if ($(this).hasClass('border')) {
                        $(this).removeClass('border');
                        $(this).removeClass('border-danger');
                    }
                });
                $(this).addClass('border border-danger');
            }

            Swal.fire({
                text: $(this).data('info'),
                showConfirmButton: false,
            });
        });

        //展開選單判段是否按過
        $('#chartShowBlock').on('click', '.btn-primary', function () {
            if (isClcik == 0) {
                isClcik = 1;
            } else {
                isClcik = 0;
            }
        });

        // 下拉選單切換圖表
        $('#chartShowBlock').on('change', '#chartTypeSelect', function () {
            $('#graphicSet').next().hide();
            $('#graphicSet').html('');
            if (myChart != 0) {
                myChart.destroy();
            }
            var data = [];
            var label = [];
            var graphicSetHtml = '';
            if ($(this).val() == '請選擇') {
                return false;
            }
            $('table').find('th').each(function () {
                label.push($(this).text());
            });

            for (let i = 0; i < label.length; i = i + 1) {
                data[i] = 0;
            }
            for (let i = 0; i < successData.length; i = i + 1) {
                for (let key in successData[i]) {
                    for (let j = 0; j < label.length; j = j + 1) {
                        if (key == label[j]) {
                            var value = 0;
                            if (!isNaN(parseInt(successData[i][key]))) {
                                data[j] = parseInt(parseInt(data[j]) + parseInt(successData[i][key]));
                            }
                        }
                    }
                }
            }

            var count = 0;
            for (let i = 0; i < data.length; i = i + 1) {
                if (data[i] == 0) {
                    count = count + 1;
                }
            }
            if (count == data.length) {
                Swal.fire({
                    icon: 'error',
                    title: '資料全都不是數字格式',
                    // showCancelButton: false,
                    confirmButtonText: '確定',
                    // allowOutsideClick: false,
                });
                return false;
            }
            var label2 = label; //直接取出順序會亂
            label = [];
            for (let i = 0; i < data.length; i = i + 1) {
                if (data[i] != 0) {
                    label.push(label2[i]);
                }
            }
            numLabel = label;

            if ($(this).val() == '圓餅圖') {
                graphicSetHtml += '<div class="col-sm-4 mt-3">請選擇圓餅圖要顯示資料的欄位:&nbsp</div><div class="col mt-3">';
                for (let i = 0; i < label.length; i = i + 1) {
                    if (i == label.length - 1) {
                        graphicSetHtml += '<div class="custom-control custom-checkbox mt-1">';
                        graphicSetHtml += '<input type="checkbox" class="custom-control-input" id="' + label[
                            i] + '" data-value="' + label[i] + '">';
                        graphicSetHtml += '<label class="custom-control-label" for="' + label[i] + '">' + label[
                            i] + '</label>';
                        graphicSetHtml += '</div>';
                    } else {
                        graphicSetHtml += '<div class="custom-control custom-checkbox mt-1">';
                        graphicSetHtml += '<input type="checkbox" class="custom-control-input" id="' + label[
                            i] + '" data-value="' + label[i] + '">';
                        graphicSetHtml += '<label class="custom-control-label" for="' + label[i] + '">' + label[
                            i] + '</label>';
                        graphicSetHtml += '</div>';
                    }
                }
                graphicSetHtml += '<button class="btn btn-warning mt-2">確定</button></div>';
                $('#graphicSet').append(graphicSetHtml);

            } else if ($(this).val() == '長條圖') {
                graphicSetHtml += '<div class="col-sm-4 mt-3">請選擇長條圖X軸要顯示資料的欄位:&nbsp</div>';
                graphicSetHtml += '<select class="col-sm-5 browser-default custom-select mt-2" id="barXChart">';
                for (let i = 0; i < label2.length; i = i + 1) {
                    if (i == 0) {
                        graphicSetHtml += '<option>請選擇</opttion>'
                        graphicSetHtml += '<option>' + label2[i] + '</opttion>';
                    } else {
                        graphicSetHtml += '<option>' + label2[i] + '</opttion>';
                    }
                }
                graphicSetHtml += '</select>'
                $('#graphicSet').append(graphicSetHtml);
            } else if ($(this).val() == '折線圖') {
                graphicSetHtml += '<div class="col-sm-4 mt-3">請選擇折線圖X軸要顯示資料的欄位:&nbsp</div>';
                graphicSetHtml += '<select class="col-sm-5 browser-default custom-select mt-2" id="barXChart">';
                for (let i = 0; i < label2.length; i = i + 1) {
                    if (i == 0) {
                        graphicSetHtml += '<option>請選擇</opttion>'
                        graphicSetHtml += '<option>' + label2[i] + '</opttion>';
                    } else {
                        graphicSetHtml += '<option>' + label2[i] + '</opttion>';
                    }
                }
                graphicSetHtml += '</select>'
                $('#graphicSet').append(graphicSetHtml);
            }
        });

        //顯示圖形
        $('#graphicSet').on('click', '.btn-warning', function () {
            var label = [];
            var data = [];
            var color = [
                '#FF5151',
                '#FF8EFF',
                '#9393FF',
                '#80FFFF',
                '#79FF79',
                '#FFFF93',
                '#FFAD86',
                '#C2C287',
            ];
            if ($("#chartShowBlock").find('select').eq(0).find("option:selected").val() == '圓餅圖') {
                if ($('#graphicSet').find('input:checked').length == 0) {
                    Swal.fire({
                        icon: 'error',
                        title: '請選擇選項',
                        // showCancelButton: false,
                        confirmButtonText: '確定',
                        // allowOutsideClick: false,
                    });
                    return false;
                }
                $('#graphicSet').next().show();
                $('#graphicSet').find('input:checked').each(function () {
                    label.push($(this).data('value'));
                });
                for (let i = 0; i < label.length; i = i + 1) {
                    data[i] = 0;
                }

                for (let i = 0; i < successData.length; i = i + 1) {
                    for (let key in successData[i]) {
                        for (let j = 0; j < label.length; j = j + 1) {
                            if (key == label[j]) {
                                var value = 0;
                                if (!isNaN(parseInt(successData[i][key]))) {
                                    data[j] = parseInt(parseInt(data[j]) + parseInt(successData[i][key]));
                                }
                            }
                        }
                    }
                }
                if (myChart == 0) {
                    myChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: label,
                            datasets: [{
                                data: data,
                                backgroundColor: color,
                            }]
                        },
                        options: {
                            responsive: true,
                            legend: {
                                labels: {
                                    fontSize: 18,
                                }
                            }
                        }
                    });
                } else {
                    myChart.destroy();
                    myChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: label,
                            datasets: [{
                                data: data,
                                backgroundColor: color,
                            }]
                        },
                        options: {
                            responsive: true,
                            legend: {
                                labels: {
                                    fontSize: 18,
                                }
                            }
                        }
                    });
                }
            } else if ($("#chartShowBlock").find('select').eq(0).find("option:selected").val() == '長條圖') {
                var label = []; //選中的資料欄位
                var dataSets = {}; //最後放入圖表的物件
                var labelX = []; //X軸的資料
                $('#graphicSet').find('input:checked').each(function () {
                    label.push($(this).data('value'));
                });

                if (label.length == 0) {
                    Swal.fire({
                        icon: 'error',
                        title: '請選擇選項',
                        // showCancelButton: false,
                        confirmButtonText: '確定',
                        // allowOutsideClick: false,
                    });
                    return false;
                }

                for (let i = 0; i < successData.length; i = i + 1) {
                    for (var key in successData[i]) {
                        if (key == $('#barXChart').find("option:selected").text().trim()) {
                            labelX.push(successData[i][key])
                        }
                    }
                }

                dataSets.labels = labelX;
                dataSets.datasets = [];
                for (let i = 0; i < label.length; i = i + 1) {
                    data = {}; //每個欄位的資料集
                    dataColnum = [];
                    for (let j = 0; j < successData.length; j = j + 1) {
                        for (var key in successData[j]) {
                            if (key == label[i]) {
                                dataColnum.push(parseInt(successData[j][key]))
                            }
                        }
                    }
                    data.data = dataColnum;
                    data.label = label[i];
                    data.backgroundColor = color[i];
                    dataSets.datasets.push(data);
                }

                $('#graphicSet').next().show();
                if (myChart == 0) {
                    myChart = new Chart(ctx, {
                        type: 'bar',
                        data: dataSets,
                        options: {
                            responsive: true,
                            legend: {
                                labels: {
                                    fontSize: 18,
                                }
                            }
                        }
                    });
                } else {
                    myChart.destroy();
                    myChart = new Chart(ctx, {
                        type: 'bar',
                        data: dataSets,
                        options: {
                            responsive: true,
                            legend: {
                                labels: {
                                    fontSize: 18,
                                }
                            }
                        }
                    });
                }
            } else if ($("#chartShowBlock").find('select').eq(0).find("option:selected").val() == '折線圖') {
                var label = []; //選中的資料欄位
                var dataSets = {}; //最後放入圖表的物件
                var labelX = []; //X軸的資料
                $('#graphicSet').find('input:checked').each(function () {
                    label.push($(this).data('value'));
                });

                if (label.length == 0) {
                    Swal.fire({
                        icon: 'error',
                        title: '請選擇選項',
                        // showCancelButton: false,
                        confirmButtonText: '確定',
                        // allowOutsideClick: false,
                    });
                    return false;
                }

                for (let i = 0; i < successData.length; i = i + 1) {
                    for (var key in successData[i]) {
                        if (key == $('#barXChart').find("option:selected").text().trim()) {
                            labelX.push(successData[i][key])
                        }
                    }
                }

                dataSets.labels = labelX;
                dataSets.datasets = [];
                for (let i = 0; i < label.length; i = i + 1) {
                    data = {}; //每個欄位的資料集
                    dataColnum = [];
                    for (let j = 0; j < successData.length; j = j + 1) {
                        for (var key in successData[j]) {
                            if (key == label[i]) {
                                dataColnum.push(parseInt(successData[j][key]))
                            }
                        }
                    }
                    data.data = dataColnum;
                    data.label = label[i];
                    data.fill = false;
                    data.borderColor = color[i];
                    data.backgroundColor = color[i];
                    dataSets.datasets.push(data);
                }

                $('#graphicSet').next().show();
                if (myChart == 0) {
                    myChart = new Chart(ctx, {
                        type: 'line',
                        data: dataSets,
                        options: {
                            responsive: true,
                            legend: {
                                labels: {
                                    fontSize: 18,
                                }
                            }
                        }
                    });
                } else {
                    myChart.destroy();
                    myChart = new Chart(ctx, {
                        type: 'line',
                        data: dataSets,
                        options: {
                            responsive: true,
                            legend: {
                                labels: {
                                    fontSize: 18,
                                }
                            }
                        }
                    });
                }
            }

        });

        // 匯出圖表
        $('#chartShowBlock').on('click', '.btn-info', function () {
            var chartType = $("#chartShowBlock").find('select').eq(0).find("option:selected").val();
            html2canvas(document.getElementById('finalChart'), {
                scrollX: 0,
                scrollY: -window.scrollY,
                type: 'view',
                scale: 3,
                background: '#FFFFFF',
                onrendered: function (canvas) {
                    // console.log(canvas.toDataURL());//這是截圖的base64
                    var link = document.createElement("a");
                    link.download = chartType + ".png";
                    link.href = canvas.toDataURL("image/png");
                    link.target = '_blank';
                    link.click();
                    // document.body.appendChild(canvas);//這是有截圖的畫布
                },
            });
        });

        //長條圖和折線圖顯示欄位設定
        $('#chartShowBlock').on('change', '#barXChart', function () {
            $('#barXChart').nextAll().each(function () {
                $(this).remove();
            });

            if ($(this).find("option:selected").text() == '請選擇') {
                return false;
            }

            var graphicBarSetHtml = '';
            graphicBarSetHtml +=
                '<div class="col-sm-4 mt-3">請選擇長條/折線圖要顯示資料的欄位:&nbsp</div><div class="col mt-3">';
            for (let i = 0; i < numLabel.length; i = i + 1) {
                if (numLabel[i] == $(this).find("option:selected").text()) {
                    continue;
                }
                if (i == numLabel.length - 1) {
                    graphicBarSetHtml += '<div class="custom-control custom-checkbox mt-1">';
                    graphicBarSetHtml += '<input type="checkbox" class="custom-control-input" id="' + numLabel[
                        i] + '" data-value="' + numLabel[i] + '">';
                    graphicBarSetHtml += '<label class="custom-control-label" for="' + numLabel[i] + '">' +
                        numLabel[i] + '</label>';
                    graphicBarSetHtml += '</div>';
                } else {
                    graphicBarSetHtml += '<div class="custom-control custom-checkbox mt-1">';
                    graphicBarSetHtml += '<input type="checkbox" class="custom-control-input" id="' + numLabel[
                        i] + '" data-value="' + numLabel[i] + '">';
                    graphicBarSetHtml += '<label class="custom-control-label" for="' + numLabel[i] + '">' +
                        numLabel[i] + '</label>';
                    graphicBarSetHtml += '</div>';
                }
            }
            graphicBarSetHtml += '<button class="btn btn-warning mt-2">確定</button></div>';
            $('#graphicSet').append(graphicBarSetHtml);
        })
    </script>

</body>

</html>
