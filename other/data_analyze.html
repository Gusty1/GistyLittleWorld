<!doctype html>
<html lang="zh-Hant-TW">

<head>
  <title>我的資料圖</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" href="../favicon.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" type="text/css" href="../css/icheck-material.min.css">
</head>

<body>

  <header></header>
  <br><br><br>

  <div class="container-fluid">

    <div class="col-12 my-3">
      <div class="row justify-content-center">
        <div class="col-sm-4 text-center">
          <h1 class="text-success h3 bg-warning rounded font-weight-bold border border-dark">生活日誌</h1>
        </div>
        <div class="col-sm-3">
          <div class="form-group row justify-content-center h5">
            <label for="" class="col-sm-4 col-form-label font-weight-bold text-center">年份</label>
            <div class="col-sm-8">
              <select class="form-control" id="lifeYear"></select>
            </div>
          </div>
        </div>
        <div class="col-sm-5">
          <div class="form-group row justify-content-center h5">
            <label class="col-sm-3 col-form-label font-weight-bold text-center">圖表類型</label>
            <div class="col-sm-9">
              <div class="icheck-material-pink icheck-inline">
                <input type="radio" id="life_bar" name="life_type" checked value="bar" />
                <label for="life_bar"><i class="fas fa-chart-bar"></i></label>
              </div>
              <div class="icheck-material-pink icheck-inline">
                <input type="radio" id="life_line" name="life_type" value="line" />
                <label for="life_line"><i class="fas fa-chart-line"></i></label>
              </div>
              <div class="icheck-material-pink icheck-inline">
                <input type="radio" id="life_radar" name="life_type" value="radar" />
                <label for="life_radar"><i class="bi bi-heart-pulse-fill"></i>&nbsp;Radar</label>
              </div>
              <div class="icheck-material-pink icheck-inline">
                <input type="radio" id="life_pie" name="life_type" value="pie" />
                <label for="life_pie"><i class="fas fa-chart-pie"></i></label>
              </div>
              <div class="icheck-material-pink icheck-inline">
                <input type="radio" id="life_polar" name="life_type" value="polarArea" />
                <label for="life_polar"><i class="bi bi-yin-yang">&nbsp;Polar</i></label>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 bg-light rounded">
        <canvas id="lifeChart" style="height:65vh;"></canvas>
      </div>
    </div>

    <div class="col-12 text-center">
      <img src="../images/other/data_analyze/divider.gif">
    </div>

    <div class="col-12 my-3">
      <div class="row justify-content-center">
        <div class="col-sm-3 text-center">
          <h1 class="text-success h3 bg-warning rounded font-weight-bold border border-dark">ACG心得</h1>
        </div>
        <div class="col-sm-2">
          <div class="form-group row justify-content-center h5">
            <label for="" class="col-sm-4 col-form-label font-weight-bold text-center">年份</label>
            <div class="col-sm-8">
              <select class="form-control" id="ACGYear"></select>
            </div>
          </div>
        </div>
        <div class="col-sm-2 text-center">
          <div class="form-group row justify-content-center h5">
            <label for="" class="col-sm-4 col-form-label font-weight-bold text-center">分類</label>
            <div class="col-sm-8">
              <select class="form-control" id="sumRate">
                <option value="rate" selected>評分</option>
                <option value="count">數量</option>
              </select>
            </div>
          </div>
        </div>
        <div class="col-sm-5">
          <div class="form-group row justify-content-center h5">
            <label class="col-sm-3 col-form-label font-weight-bold text-center">圖表類型</label>
            <div class="col-sm-9">
              <div class="icheck-material-deeporange icheck-inline">
                <input type="radio" id="ACG_bar" name="ACG_type" checked value="bar" />
                <label for="ACG_bar"><i class="fas fa-chart-bar"></i></label>
              </div>
              <div class="icheck-material-deeporange icheck-inline">
                <input type="radio" id="ACG_line" name="ACG_type" value="line" />
                <label for="ACG_line"><i class="fas fa-chart-line"></i></label>
              </div>
              <div class="icheck-material-deeporange icheck-inline">
                <input type="radio" id="ACG_radar" name="ACG_type" value="radar" />
                <label for="ACG_radar"><i class="bi bi-heart-pulse-fill"></i>&nbsp;Radar</label>
              </div>
              <div class="icheck-material-deeporange icheck-inline">
                <input type="radio" id="ACG_pie" name="ACG_type" value="pie" />
                <label for="ACG_pie"><i class="fas fa-chart-pie"></i></label>
              </div>
              <div class="icheck-material-deeporange icheck-inline">
                <input type="radio" id="ACG_polar" name="ACG_type" value="polarArea" />
                <label for="ACG_polar"><i class="bi bi-yin-yang">&nbsp;Polar</i></label>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 bg-light rounded">
        <canvas id="ACGChart" style="height:65vh;"></canvas>
      </div>
    </div>
  </div>

  <div class="container-xl">
    <div class="accordion mb-3" id="authorGGYY">
      <div class="card">
        <div class="card-header">
          <h2 class="mb-0 text-center"><i class="fas fa-skull"></i>
            <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#description1" aria-expanded="true" aria-controls="description1">
              創作動機
            </button>
          </h2>
        </div>
        <div id="description1" class="collapse" data-parent="#authorGGYY">
          <div class="card-body">
            某天整理資料時，突然發覺資料變好多喔，那484應該要有個視覺化之類的。
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h2 class="mb-0 text-center"><i class="fas fa-meteor"></i>
            <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#description2" aria-expanded="false" aria-controls="description2">
              功能說明
            </button>
          </h2>
        </div>
        <div id="description2" class="collapse" data-parent="#authorGGYY">
          <div class="card-body">
            就一堆圖表，因為我找不到Radar和Polar的icon，所以我隨便找2個感覺很帥的圖。<br>
            X軸都固定是月份，Y軸都是數量，其他的就自己按看看。
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header" id="headingThree">
          <h2 class="mb-0 text-center"><i class="fas fa-ghost"></i>
            <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#description3" aria-expanded="false" aria-controls="description3">
              心得感想
            </button>
          </h2>
        </div>
        <div id="description3" class="collapse" aria-labelledby="headingThree" data-parent="#authorGGYY">
          <div class="card-body">
            生活的可能因為有些數量差異都不大，所以就算用成圖表也看不出甚麼變化；果然垃圾話極多。<br>
            ACG的用評分去看，分的項目太多反而很亂；動畫的比例極高，然後1分的也不少，難道我沒有看動畫的眼光嗎?<br>
            線性圖或其他有節點的圖因為滑鼠圖標不是正常的，所以很難滑到點上，但我還是不會換回來的，這是阿宅的堅持。
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="goTop">
    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-arrow-up-circle-fill" viewBox="0 0 16 16">
      <path d="M16 8A8 8 0 1 0 0 8a8 8 0 0 0 16 0zm-7.5 3.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11.5z" />
    </svg>
  </div>

  <footer></footer>

  <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>
  <script src="../js/fairyDustCursor.js"></script>
  <script src="../js/bubbly-bg.js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@10"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.6.5/firebase-database.min.js" integrity="sha512-x+FKkd5Tc/5BaHtn/ZnRsQlzaEihtLaCOev36dCv5eeyGEDf5ou59tz7q6CypiKBN/L51E0Jd5S7jxIg1v8lcg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="../js/jquery.blockUI.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="../js/tool.js"></script>

  <script>
    var LifeData = ''
    var ACGData = ''
    var LifeChart = ''
    var ACGChart = ''

    var MonthAry = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
    var BackgroundColor = [
      'rgba(139,0,0,0.6)',
      'rgba(54, 162, 235,0.6)',
      'rgba(255, 206, 86,0.6)',
      'rgba(255,0,0,0.6)',
      'rgba(47,79,79,0.6)',
      'rgba(255,20,147,0.6)',
      'rgba(0, 100, 0,0.6)',
      'rgba(148, 0, 211,0.6)',
      'rgba(250,128,114,0.6)',
      'rgba(124,252,0,0.6)',
      'rgba(233,150,122,0.6)',
      'rgba(0,255,255,0.6)',
      'rgba(210,105,30,0.6)'
    ]
    var BorderColor = [
      'rgba(139,0,0)',
      'rgba(54, 162, 235)',
      'rgba(255, 206, 86)',
      'rgba(255,0,0)',
      'rgba(47,79,79)',
      'rgba(255,20,147)',
      'rgba(0, 100, 0)',
      'rgba(148, 0, 211)',
      'rgba(250,128,114)',
      'rgba(124,252,0)',
      'rgba(233,150,122)',
      'rgba(0,255,255)',
      'rgba(210,105,30)'
    ]

    //取得初始資料
    $(document).ready(async () => {
      $.blockUI({
        message: randomLoader(),
        css: {
          borderWidth: '0px',
          backgroundColor: 'transparent'
        },
        baseZ: 1000,
      });
      $('header').load("../header.html")
      $("footer").load("../footer.html");
      setYear()
      LifeData = await getFirebaseData('life')
      ACGData = await getFirebaseData('ACG')
      // console.log(LifeData)
      // console.log(ACGData)
      setLifeChart($('#lifeYear').val(), $('input[name="life_type"]:checked').val())
      setACGChart($('#ACGYear').val(), $('input[name="ACG_type"]:checked').val(), $('#sumRate').val())
      $.unblockUI();
    })

    //生活日誌選項切換
    $('body').on('change', '#lifeYear,input[name="life_type"]', () => {
      setLifeChart($('#lifeYear').val(), $('input[name="life_type"]:checked').val())
    })

    //ACG心得選項切換
    $('body').on('change', '#ACGYear,input[name="ACG_type"],#sumRate', () => {
      setACGChart($('#ACGYear').val(), $('input[name="ACG_type"]:checked').val(), $('#sumRate').val())
    })

    //取得資料
    function getFirebaseData(catalog) {
      return new Promise((resolve, reject) => {
        database.ref('/' + catalog).once('value', (result) => {
          resolve(result.val())
        })
      })
    }

    //設定年分
    function setYear() {
      let optionHtml = ''
      let nowYear = new Date().getFullYear()
      for (let i = 2021; i <= nowYear; i++) {
        if (i === nowYear) optionHtml += '<option value="' + i + '" selected>' + i + '</option>'
        else optionHtml += '<option value="' + i + '">' + i + '</option>'
      }
      $('#lifeYear').html(optionHtml)
      $('#ACGYear').html(optionHtml)
    }

    //設定生活日誌的圖表
    function setLifeChart(year, chartType) {
      let scales = {}
      let data = {}
      let max = 0
      let datasets = []
      let thisYearData = LifeData.filter((item) => {
        return new Date(item.time).getFullYear() === parseInt(year)
      })
      let labelAry = removeDuplicates(thisYearData, 'label')
      labelAry = labelAry.map((item) => {
        return item.label
      })

      if (chartType === 'pie' || chartType === 'polarArea') {
        let countAry = []
        let singleDataObj = {
          filterDataAry: []
        }
        for (let i = 0; i < labelAry.length; i++) {
          countAry[i] = 0
          for (let j = 0; j < thisYearData.length; j++) {
            if (thisYearData[j].label === labelAry[i]) {
              singleDataObj.filterDataAry.push(thisYearData[j])
              countAry[i]++
            }
          }
          if (countAry[i] > max) max = countAry[i]
        }
        singleDataObj.label = '數量'
        if (chartType === 'polarArea') singleDataObj.backgroundColor = BackgroundColor
        else singleDataObj.backgroundColor = BorderColor
        singleDataObj.data = countAry
        datasets.push(singleDataObj)
        data.labels = labelAry
        data.datasets = datasets
      } else {
        for (let i = 0; i < labelAry.length; i++) {
          let dataObj = {
            label: labelAry[i],
            backgroundColor: BackgroundColor[i],
            borderColor: BorderColor[i],
            borderWidth: 1,
            data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            fill: true,
            pointStyle: 'circle',
            pointRadius: 6,
            pointHoverRadius: 9,
            tension: 0.4,
            filterDataAry: [],
          }
          for (let m = 1; m <= 12; m++) {
            for (let j = 0; j < thisYearData.length; j++) {
              if (thisYearData[j].label === labelAry[i] && new Date(thisYearData[j].time).getMonth() + 1 === m) {
                dataObj.data[m - 1]++
                dataObj.filterDataAry.push(thisYearData[j])
              }
            }
            if (dataObj.data[m - 1] > max) max = dataObj.data[m - 1]
          }
          datasets.push(dataObj)
        }
        data.labels = MonthAry
        data.datasets = datasets
      }

      if (chartType === 'bar' || chartType === 'line') {
        scales = {
          y: {
            ticks: {
              stepSize: 1,
            },
            beginAtZero: true,
            max: max + 2,
          },
          x: {
            beginAtZero: true,
          },
        }
      } else if (chartType === 'radar' || chartType === 'polarArea') {
        scales = {
          r: {
            ticks: {
              stepSize: 1,
            },
            beginAtZero: true,
            max: max + 2,
          },
        }
      } else scales = {}

      let footer = (tooltipItems) => {
        tooltipItems = tooltipItems[0]
        let dataAry = [...tooltipItems.dataset.filterDataAry]
        let titleAry = []
        if (chartType === 'pie' || chartType === 'polarArea') {
          dataAry = dataAry.filter((item) => {
            return item.label === tooltipItems.label
          })
        } else {
          dataAry = dataAry.filter((item) => {
            return item.label === tooltipItems.dataset.label && new Date(item.time).getMonth() === tooltipItems.dataIndex
          })
        }
        for (let i = 0; i < dataAry.length; i++) {
          titleAry.push(dataAry[i].title + '\n')
        }
        return titleAry.toString().substring(0, titleAry.toString().lastIndexOf('\n')).replaceAll(',', '')
      };

      if (LifeChart !== '') LifeChart.destroy()
      LifeChart = new Chart(document.getElementById('lifeChart'), {
        type: chartType,
        data: data,
        options: {
          maintainAspectRatio: false,
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                font: {
                  size: 18
                }
              }
            },
            title: {
              display: false,
            },
            tooltip: {
              callbacks: {
                footer: footer,
              }
            }
          },
          scales,
        },
      });
    }

    //設定ACG的圖表
    function setACGChart(year, chartType, type) {
      let scales = {}
      let data = {}
      let max = 0
      let datasets = []
      let typeAry = []
      let thisYearData = ACGData.filter((item) => {
        return new Date(item.time).getFullYear() === parseInt(year)
      })

      if (type === 'rate') {
        typeAry = removeDuplicates(thisYearData, 'rate')
        typeAry = typeAry.sort((a, b) => {
          return a.rate - b.rate
        })
        typeAry = typeAry.map((item) => {
          return item.rate
        })
      } else {
        typeAry = removeDuplicates(thisYearData, 'type')
        typeAry = typeAry.map((item) => {
          return item.type
        })
      }

      if (chartType === 'pie' || chartType === 'polarArea') {
        let countAry = []
        let singleDataObj = {
          filterDataAry: []
        }
        for (let i = 0; i < typeAry.length; i++) {
          countAry[i] = 0
          if (type === 'rate') {
            for (let j = 0; j < thisYearData.length; j++) {
              if (thisYearData[j].rate === typeAry[i]) {
                countAry[i]++
                singleDataObj.filterDataAry.push(thisYearData[j])
              }
            }
          } else {
            for (let j = 0; j < thisYearData.length; j++) {
              if (thisYearData[j].type === typeAry[i]) {
                countAry[i]++
                singleDataObj.filterDataAry.push(thisYearData[j])
              }
            }
          }
          if (countAry[i] > max) max = countAry[i]
        }
        singleDataObj.label = '數量'
        if (chartType === 'polarArea') singleDataObj.backgroundColor = BackgroundColor
        else singleDataObj.backgroundColor = BorderColor
        singleDataObj.data = countAry
        datasets.push(singleDataObj)
        data.labels = typeAry
        data.datasets = datasets
      } else {
        for (let i = 0; i < typeAry.length; i++) {
          let dataObj = {
            label: typeAry[i],
            backgroundColor: BackgroundColor[i],
            borderColor: BorderColor[i],
            borderWidth: 1,
            data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            fill: true,
            pointStyle: 'circle',
            pointRadius: 6,
            pointHoverRadius: 9,
            tension: 0.4,
            filterDataAry: []
          }
          for (let m = 1; m <= 12; m++) {
            for (let j = 0; j < thisYearData.length; j++) {
              if (type === 'rate') {
                if (thisYearData[j].rate === typeAry[i] && new Date(thisYearData[j].time).getMonth() + 1 === m) {
                  dataObj.data[m - 1]++
                  dataObj.filterDataAry.push(thisYearData[j])
                }
              } else {
                if (thisYearData[j].type === typeAry[i] && new Date(thisYearData[j].time).getMonth() + 1 === m) {
                  dataObj.data[m - 1]++
                  dataObj.filterDataAry.push(thisYearData[j])
                }
              }
            }
            if (dataObj.data[m - 1] > max) max = dataObj.data[m - 1]
          }
          datasets.push(dataObj)
        }
        data.labels = MonthAry
        data.datasets = datasets
      }
      if (chartType === 'bar' || chartType === 'line') {
        scales = {
          y: {
            ticks: {
              stepSize: 1,
            },
            beginAtZero: true,
            max: max + 2,
          },
          x: {
            beginAtZero: true,
          },
        }
      } else if (chartType === 'radar' || chartType === 'polarArea') {
        scales = {
          r: {
            ticks: {
              stepSize: 1,
            },
            beginAtZero: true,
            max: max + 2,
          },
        }
      } else scales = {}

      let footer = (tooltipItems) => {
        tooltipItems = tooltipItems[0]
        let dataAry = [...tooltipItems.dataset.filterDataAry]
        let titleAry = []

        if (type === 'rate') {
          if (chartType === 'pie' || chartType === 'polarArea') {
            dataAry = dataAry.filter((item) => {
              return item.rate === tooltipItems.label
            })
          } else {
            dataAry = dataAry.filter((item) => {
              return item.rate === tooltipItems.dataset.label && new Date(item.time).getMonth() === tooltipItems.dataIndex
            })
          }
        } else {
          if (chartType === 'pie' || chartType === 'polarArea') {
            dataAry = dataAry.filter((item) => {
              return item.type === tooltipItems.label
            })
          } else {
            dataAry = dataAry.filter((item) => {
              return item.type === tooltipItems.dataset.label && new Date(item.time).getMonth() === tooltipItems.dataIndex
            })
          }
        }

        for (let i = 0; i < dataAry.length; i++) {
          titleAry.push(dataAry[i].title + '\n')
        }
        return titleAry.toString().substring(0, titleAry.toString().lastIndexOf('\n')).replaceAll(',', '')
      };

      if (ACGChart !== '') ACGChart.destroy()
      ACGChart = new Chart(document.getElementById('ACGChart'), {
        type: chartType,
        data: data,
        options: {
          maintainAspectRatio: false,
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                font: {
                  size: 18
                }
              }
            },
            title: {
              display: false,
            },
            tooltip: {
              callbacks: {
                footer: footer,
              }
            }
          },
          scales,
        },
      });
    }
  </script>

</body>

</html>